#!/usr/bin/env python2

import sys
import os
import socket
import time
import json
import traceback
import pulsectl
try:
	import better_exchook
except ImportError:
	class DummyBetterExecHook(object):
		def install(self):
			pass
	better_exchook = DummyBetterExecHook()


APPNAME = 'paosd'


def json_serializer(obj):
	classname = obj.__class__.__name__
	serialized = {'class': classname, 'object': {}}
	if isinstance(obj, pulsectl.PulseSinkInfo):
		serialized['object'] = {'name': obj.name}
	return serialized

def json_deserializer(d):
	classname = d.get('class')
	if classname == 'PulseSinkInfo':
		d = TODO .get_sink_by_name(d['object']['name'])
		#TODO dont pass PulseSinkInfo objects but FlatPulseSinkInfo
		#or pass by object id and instanciate a proxy object in the parent...
	return d

if '--pulse-rpc' in sys.argv:
	better_exchook.install()
	child_sock_fd = int(sys.argv[2])
	rfile = os.fdopen(child_sock_fd, 'r')
	wfile = os.fdopen(child_sock_fd, 'w')
	pa = pulsectl.Pulse(APPNAME)
	while True:
		line = rfile.readline()
		if line == '': break
		rpc = json.loads(line, object_hook=json_deserializer)
		method = getattr(pa, rpc['method'])
		answer = method(*rpc['args'])
		wfile.write(json.dumps(answer, default=json_serializer) + "\n")
		wfile.flush()
	raise SystemExit(0)



import threading
import gtk
import hband_tools.gui as gui
better_exchook.install()


def listen_pulse_events():
	while State['run']:
		if State['pulse_listener'] is None: State['pulse_listener'] = pulsectl.Pulse(APPNAME)
		State['pulse_listener'].event_mask_set('sink')
		State['pulse_listener'].event_callback_set(on_pulse_event)
		try:
			State['pulse_listener'].event_listen(timeout=None)
		except pulsectl.PulseDisconnected:
			State['pulse_listener'] = None
		except:
			pass

def on_pulse_event(event):
	for sink in pulseproxy.call('sink_list'):
		sink_desc = sink.description
		port_desc = sink.port_active.description
		muted = sink.mute
		volume = sink.volume.value_flat * 100
		volume = int(volume)
		display_volume(sink, sink_desc, port_desc, muted, volume)

InfoDisplayedPerDevice = {}

def display_volume(pa_sink, device, device_port, muted, volume):
	key = (device, device_port)
	info = (muted, volume)
	if InfoDisplayedPerDevice.get(key, (None, None)) != info:
		gtk.threads_enter()
		main_win.current_pa_sink = pa_sink
		main_win.update(device + " - " + device_port, muted, volume)
		# TODO timer to hide
		gtk.threads_leave()
		InfoDisplayedPerDevice[key] = info

class VolumeWindow(gui.Window):
	def __init__(self):
		self.current_pa_sink = None
		
		super(VolumeWindow, self).__init__({'name': 'window.main', 'gtk-args': [gtk.WINDOW_TOPLEVEL]})
		self.set_decorated(False)
		self.set_skip_taskbar_hint(True)
		self.set_skip_pager_hint(True)
		self.set_keep_above(True)
		
		frame = gtk.Frame()
		frame.set_shadow_type(gtk.SHADOW_OUT)
		box = gtk.VBox(homogeneous=False, spacing=0)
		hbox = gtk.HBox(homogeneous=False, spacing=5)
		
		self.scale = gtk.HScale(gtk.Adjustment(0.0, 0.0, 100.0, 1.0, 10.0, 0.0))
		self.scale.set_update_policy(gtk.UPDATE_CONTINUOUS)
		self.scale.set_draw_value(False)
		self.scale.set_inverted(False)
		self.scale.set_size_request(120, 0)
		self.scale.connect('change-value', self.change_volume_current_device_port)
		
		self.icon = gtk.ToolButton()
		self.icon.connect('clicked', self.toggle_mute_current_device_port)
		self.voltext = gtk.Label()
		self.voltext.set_width_chars(4)
		self.label = gtk.Label()
		self.label.set_alignment(0, 0.5)
		
		box.pack_start(hbox, expand=False, fill=False, padding=0)
		hbox.pack_start(self.icon, expand=False, fill=False, padding=0)
		hbox.pack_start(self.voltext, expand=False, fill=False, padding=0)
		hbox.pack_start(self.scale, expand=True, fill=True, padding=0)
		box.pack_start(self.label, expand=True, fill=True, padding=0)
		frame.add(box)
		self.add(frame)
	
	def toggle_mute_current_device_port(self, button):
		muted = button.get_data('muted')
		pulseproxy.call('mute', self.current_pa_sink, not muted)
		#self.update_icon(not muted)
	
	def change_volume_current_device_port(self, range_obj, scroll_type, value):
		pulseproxy.call('volume_set_all_chans', self.current_pa_sink, value/100)
	
	def update(self, label, muted, volume):
		self.scale.set_value(volume)
		self.update_icon(muted)
		self.voltext.set_text('%d%%' % volume)
		self.label.set_text(label)
		self.show_all()
	
	def update_icon(self, muted):
		self.icon.set_data('muted', muted)
		volume = self.scale.get_value()
		if muted or volume <= 0: icon_variant = 'mute'
		elif volume < 33:        icon_variant = 'min'
		elif volume < 66:        icon_variant = 'med'
		else:                    icon_variant = 'max'
		self.icon.set_icon_name('stock_volume-%s' % icon_variant)

class EmptyResponseError(Exception):
	pass

class PulseProxy(object):
	def __init__(self):
		self.child_pid = None
	
	def call(self, method, *args):
		n_spawns = 0
		if self.child_pid is None:
			self.spawn()
			n_spawns += 1
		rpc = json.dumps({'method': method, 'args': args}, default=json_serializer)
		while n_spawns < 2:
			try:
				self.wfile.write(rpc + "\n")
				self.wfile.flush()
				response = self.rfile.readline()
				if response == '': raise EmptyResponseError
				rpc_response = json.loads(response, object_hook=json_deserializer)
				return rpc_response
			except (IOError, OSError, EmptyResponseError) as exc:
				self.spawn()
				n_spawns += 1
	
	def spawn(self):
		parent_sock, child_sock = socket.socketpair()
		# TODO cleanup unused sockets
		pid = os.fork()
		if pid == 0:
			parent_sock.close()
			os.execve(sys.executable, [sys.executable, __file__, '--pulse-rpc', str(child_sock.fileno())], os.environ)
			raise SystemExit(127)
		else:
			self.child_pid = pid
			child_sock.close()
			self.rpc_sock = parent_sock
			self.rfile = parent_sock.makefile('r')
			self.wfile = parent_sock.makefile('w')




State = {
	'run': True,
	'pulse_listener': None,
}


pulseproxy = PulseProxy()

gtk.gdk.threads_init()
pulse_listen_thr = threading.Thread(target=listen_pulse_events, name='Pulse listener')
pulse_listen_thr.setDaemon(True)
pulse_listen_thr.start()

main_win = VolumeWindow()
main_win.hide()
try:
	gtk.main()
except KeyboardInterrupt:
	pass

State['run'] = False
if State['pulse_listener'] is not None: State['pulse_listener'].disconnect()
pulse_listen_thr.join()
