#!/usr/bin/env python3

import os
import pulsectl
import time
import traceback


def listen_pulse_events():
	while True:
		try:
			while True:
				pulse_listener.event_listen(timeout=86400)
				time.sleep(1)
		except pulsectl.PulseDisconnected:
			traceback.print_exc()


def pulseSink():
	default = pulse_blocking.server_info().default_sink_name
	for sink in pulse_blocking.sink_list():
		if sink.name == default:
			return sink
	return pulse_blocking.sink_list()[0]


def pulse_event(event):
	sink = pulseSink()
	desc = sink.description
	muted = sink.mute
	volume = sink.volume.value_flat * 100
	volume = int(volume)
	if muted:
		display_volume(volume, f"{desc} - MUTED ({int(volume)}%)")
	else:
		display_volume(volume, f"{desc} - {int(volume)}%")


class CallOnlyWhenParamsChanged(object):
	def __init__(self, func):
		self.func = func
		self.last_pparam = None
		self.last_kwparam = None
		
	def __call__(self, *pparam, **kwparam):
		if self.last_pparam != pparam or self.last_kwparam != kwparam:
			self.func(*pparam, **kwparam)


def osd_volume(volume, label='volume'):
	label_esc = label.replace(')', '\\)')
	osd(f"bars({label_esc},{volume})")


def osd(command):
	with open(f"/tmp/osdsh.{os.getuid()}", 'w') as fh:
		fh.write(command)


display_volume = CallOnlyWhenParamsChanged(osd_volume)

pulse_listener = pulsectl.Pulse('paosd')
pulse_blocking = pulsectl.Pulse('paosd')

pulse_listener.event_mask_set('sink')
pulse_listener.event_callback_set(pulse_event)
listen_pulse_events()
